---
- name: Bootstrap kind-based Spark dev cluster with Spark Operator and JupyterHub
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Match the name you used in your kind commands (or stick to spark-dev)
    kind_cluster_name: spark-cluster
    spark_operator_release: spark-operator
    spark_operator_namespace: spark-operator
    jupyterhub_release: jhub
    jupyterhub_namespace: jhub-dev

    # Treat this playbook as being inside ansible/playbooks relative to repo root
    repo_root: "{{ playbook_dir }}/../.."

    load_images: false

    # ============================================
    # Local dev: runtime-mount LER-U into kind nodes
    # ============================================
    leru_mount_enabled: true
    leru_host_path: "/Users/vifro/Downloads/LER-U_redesign"
    leru_node_path: "/mnt/leru"
    kind_config_path: "/tmp/kind-{{ kind_cluster_name }}-config.yaml"

    # ============================================
    # Default values for standalone execution
    # When using inventory files, these are overridden
    # ============================================

    # Helm repository configuration (defaults to public internet repos)
    _helm_spark_operator_repo_name: "{{ helm_spark_operator_repo_name | default('spark-operator') }}"
    _helm_spark_operator_repo_url: "{{ helm_spark_operator_repo_url | default('https://kubeflow.github.io/spark-operator') }}"
    _helm_jupyterhub_repo_name: "{{ helm_jupyterhub_repo_name | default('jupyterhub') }}"
    _helm_jupyterhub_repo_url: "{{ helm_jupyterhub_repo_url | default('https://jupyterhub.github.io/helm-chart/') }}"

    # Image configuration (defaults to public Docker Hub)
    _spark_base_image: "{{ spark_base_image | default('statkube/spark-base:spark3.5.3-py3.12-1') }}"
    _spark_notebook_image: "{{ spark_notebook_image | default('statkube/spark-notebook:spark3.5.3-py3.12-1') }}"

  tasks:
    - name: Display environment configuration
      ansible.builtin.debug:
        msg: |
          Environment: {{ environment_name | default('internet (default)') }}
          Spark Operator Helm Repo: {{ helm_spark_operator_repo_url }}
          JupyterHub Helm Repo: {{ helm_jupyterhub_repo_url }}
          Spark Base Image: {{ spark_base_image }}
          Spark Notebook Image: {{ spark_notebook_image }}

    - name: Write kind cluster config (includes optional LER-U host mount)
      ansible.builtin.copy:
        dest: "{{ kind_config_path }}"
        mode: "0644"
        content: |
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
            - role: control-plane
              {% if leru_mount_enabled | bool %}
              extraMounts:
                - hostPath: {{ leru_host_path }}
                  containerPath: {{ leru_node_path }}
              {% endif %}
            - role: worker
              {% if leru_mount_enabled | bool %}
              extraMounts:
                - hostPath: {{ leru_host_path }}
                  containerPath: {{ leru_node_path }}
              {% endif %}
            - role: worker
              {% if leru_mount_enabled | bool %}
              extraMounts:
                - hostPath: {{ leru_host_path }}
                  containerPath: {{ leru_node_path }}
              {% endif %}

    - name: Ensure kind cluster exists
      ansible.builtin.command:
        cmd: "kind create cluster --name {{ kind_cluster_name }} --config {{ kind_config_path }}"
      register: kind_create
      failed_when: kind_create.rc not in [0, 1]
      changed_when: kind_create.rc == 0

    - name: Warn if kind cluster already exists and LER-U mount is enabled
      ansible.builtin.debug:
        msg: |
          ⚠️ kind cluster '{{ kind_cluster_name }}' already exists.
          LER-U mount expects '{{ leru_node_path }}' to be present via kind extraMounts.
          If notebooks cannot see /opt/leru, recreate the cluster:
            kind delete cluster --name {{ kind_cluster_name }}
            ansible-playbook ansible/playbooks/kind_dev.yml
      when:
        - leru_mount_enabled | bool
        - kind_create.rc == 1

    - name: Use kind cluster context
      ansible.builtin.command:
        cmd: "kubectl config use-context kind-{{ kind_cluster_name }}"

    - name: Optionally load base image into kind
      ansible.builtin.command:
        cmd: "kind load docker-image {{ spark_base_image }} --name {{ kind_cluster_name }}"
      when: load_images | bool

    - name: Optionally load notebook image into kind
      ansible.builtin.command:
        cmd: "kind load docker-image {{ spark_notebook_image }} --name {{ kind_cluster_name }}"
      when: load_images | bool

    - name: Add Spark Operator Helm repo
      ansible.builtin.command:
        cmd: "helm repo add {{ _helm_spark_operator_repo_name }} {{ _helm_spark_operator_repo_url }}"
      register: spark_repo
      changed_when: "'has been added' in spark_repo.stdout"
      failed_when: spark_repo.rc not in [0]

    - name: Add JupyterHub Helm repo
      ansible.builtin.command:
        cmd: "helm repo add {{ _helm_jupyterhub_repo_name }} {{ _helm_jupyterhub_repo_url }}"
      register: jhub_repo
      changed_when: "'has been added' in jhub_repo.stdout"
      failed_when: jhub_repo.rc not in [0]

    - name: Update Helm repos
      ansible.builtin.command:
        cmd: "helm repo update"
      register: helm_repo_update
      failed_when: false

    - name: Install or upgrade Spark Operator (dev)
      ansible.builtin.command:
        cmd: >
          helm upgrade --install {{ spark_operator_release }} {{ _helm_spark_operator_repo_name }}/spark-operator
          --version 1.1.27
          --namespace {{ spark_operator_namespace }} --create-namespace
          -f {{ repo_root }}/k8s/spark-operator/values-base.yaml
          -f {{ repo_root }}/k8s/spark-operator/values-dev.yaml

    - name: Install or upgrade JupyterHub (dev - internet)
      ansible.builtin.command:
        cmd: >
          helm upgrade --install {{ jupyterhub_release }} {{ _helm_jupyterhub_repo_name }}/jupyterhub
          --namespace {{ jupyterhub_namespace }} --create-namespace
          -f {{ repo_root }}/k8s/jupyterhub/values-base.yaml
          -f {{ repo_root }}/k8s/jupyterhub/values-dev.yaml
          -f {{ repo_root }}/k8s/jupyterhub/values-kind.yaml
      when: environment_name | default('internet') == 'internet'

    - name: Install or upgrade JupyterHub (dev - onprem)
      ansible.builtin.command:
        cmd: >
          helm upgrade --install {{ jupyterhub_release }} {{ _helm_jupyterhub_repo_name }}/jupyterhub
          --namespace {{ jupyterhub_namespace }} --create-namespace
          -f {{ repo_root }}/k8s/jupyterhub/values-base.yaml
          -f {{ repo_root }}/k8s/jupyterhub/values-onprem.yaml
          -f {{ repo_root }}/k8s/jupyterhub/values-kind.yaml
      when: environment_name | default('internet') == 'onprem'

    - name: Deploy MinIO (internet)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/minio/minio.yaml"
      when: environment_name | default('internet') == 'internet'

    - name: Deploy MinIO (onprem)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/minio/minio-onprem.yaml"
      when: environment_name | default('internet') == 'onprem'

    - name: Wait for MinIO deployment to be ready
      ansible.builtin.command:
        cmd: "kubectl wait --for=condition=available deployment/minio -n minio --timeout=120s"
      register: minio_wait
      failed_when: false

    - name: Deploy Polaris (internet)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/polaris/polaris.yaml"
      when: environment_name | default('internet') == 'internet'

    - name: Deploy Polaris (onprem)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/polaris/polaris-onprem.yaml"
      when: environment_name | default('internet') == 'onprem'

    - name: Wait for Polaris deployment to be ready
      ansible.builtin.command:
        cmd: "kubectl wait --for=condition=available deployment/polaris -n polaris --timeout=120s"
      register: polaris_wait
      failed_when: false

    - name: Delete existing Polaris bootstrap job (if any)
      ansible.builtin.command:
        cmd: "kubectl delete job polaris-bootstrap-catalog -n polaris --ignore-not-found"

    - name: Bootstrap Polaris S3-backed catalog (idempotent)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/polaris/polaris-bootstrap.yaml"

    - name: Create spark-sa ServiceAccount in jhub-dev
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/jupyterhub/service-account.yaml"

    - name: Grant spark-sa access to default namespace
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/jupyterhub/spark-rbac.yaml"

    - name: Create spark-sa ServiceAccount in default namespace
      ansible.builtin.command:
        cmd: "kubectl create serviceaccount spark-sa --namespace default"
      register: create_sa_default
      failed_when: create_sa_default.rc not in [0, 1]
      changed_when: create_sa_default.rc == 0
