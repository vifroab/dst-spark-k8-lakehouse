---
- name: Bootstrap k3d-based Spark dev cluster with Spark Operator and JupyterHub
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Cluster name for k3d
    k3d_cluster_name: spark-cluster
    spark_operator_release: spark-operator
    spark_operator_namespace: spark-operator
    jupyterhub_release: jhub
    jupyterhub_namespace: jhub-dev

    # Treat this playbook as being inside ansible/playbooks relative to repo root
    repo_root: "{{ playbook_dir }}/../.."

    load_images: false

    # k3d port mappings (host:container@loadbalancer)
    k3d_http_port: "8080:80@loadbalancer"
    k3d_https_port: "8443:443@loadbalancer"
    k3d_agents: 2

    # ============================================
    # Local dev: runtime-mount LER-U into k3d nodes
    # ============================================
    leru_mount_enabled: true
    leru_host_path: "/Users/vifro/Downloads/LER-U_redesign"
    leru_node_path: "/mnt/leru"
    # Recreate the cluster when runtime-mounting host paths (ensures volume mount is present)
    k3d_recreate_cluster: "{{ leru_mount_enabled | bool }}"

    # ============================================
    # Default values for standalone execution
    # When using inventory files, these are overridden
    # ============================================

    # Helm repository configuration (defaults to public internet repos)
    _helm_spark_operator_repo_name: "{{ helm_spark_operator_repo_name | default('spark-operator') }}"
    _helm_spark_operator_repo_url: "{{ helm_spark_operator_repo_url | default('https://kubeflow.github.io/spark-operator') }}"
    _helm_jupyterhub_repo_name: "{{ helm_jupyterhub_repo_name | default('jupyterhub') }}"
    _helm_jupyterhub_repo_url: "{{ helm_jupyterhub_repo_url | default('https://jupyterhub.github.io/helm-chart/') }}"

    # Image configuration (defaults to public Docker Hub)
    _spark_base_image: "{{ spark_base_image | default('statkube/spark-base:spark3.5.3-py3.12-1') }}"
    _spark_notebook_image: "{{ spark_notebook_image | default('statkube/spark-notebook:spark3.5.3-py3.12-1') }}"

  tasks:
    - name: Display environment configuration
      ansible.builtin.debug:
        msg: |
          Environment: {{ environment_name | default('internet (default)') }}
          Cluster Type: k3d (k3s in Docker)
          Spark Operator Helm Repo: {{ _helm_spark_operator_repo_url }}
          JupyterHub Helm Repo: {{ _helm_jupyterhub_repo_url }}
          Spark Base Image: {{ _spark_base_image }}
          Spark Notebook Image: {{ _spark_notebook_image }}
          Port Mappings: {{ k3d_http_port }}, {{ k3d_https_port }}

    - name: Check if k3d cluster already exists
      ansible.builtin.command:
        cmd: "k3d cluster list -o json"
      register: k3d_list
      changed_when: false
      failed_when: false

    - name: Recreate k3d cluster for local dev runtime mounts (delete first)
      ansible.builtin.command:
        cmd: "k3d cluster delete {{ k3d_cluster_name }}"
      register: k3d_delete
      failed_when: false
      changed_when: k3d_delete.rc == 0
      when: k3d_recreate_cluster | bool

    - name: Create k3d cluster with port mappings
      ansible.builtin.command:
        cmd: >
          k3d cluster create {{ k3d_cluster_name }}
          --agents {{ k3d_agents }}
          --port {{ k3d_http_port }}
          --port {{ k3d_https_port }}
          {% if leru_mount_enabled | bool %}
          --volume {{ leru_host_path }}:{{ leru_node_path }}@all
          {% endif %}
      register: k3d_create
      when: (k3d_recreate_cluster | bool) or (k3d_cluster_name not in (k3d_list.stdout | default('')))
      failed_when: k3d_create.rc not in [0, 1]
      changed_when: k3d_create.rc == 0

    - name: Warn if k3d cluster already exists and LER-U mount is enabled
      ansible.builtin.debug:
        msg: |
          ⚠️ k3d cluster '{{ k3d_cluster_name }}' already exists.
          LER-U mount expects the node path '{{ leru_node_path }}' to be present via k3d --volume.
          If notebooks cannot see /opt/leru, recreate the cluster:
            k3d cluster delete {{ k3d_cluster_name }}
            ansible-playbook ansible/playbooks/k3d_dev.yml
      when:
        - leru_mount_enabled | bool
        - k3d_cluster_name in (k3d_list.stdout | default(''))

    - name: Ensure k3d kubeconfig is merged and context exists
      ansible.builtin.command:
        cmd: >
          k3d kubeconfig merge {{ k3d_cluster_name }}
          --kubeconfig-merge-default
          --kubeconfig-switch-context
      changed_when: false

    - name: Use k3d cluster context
      ansible.builtin.command:
        cmd: "kubectl config use-context k3d-{{ k3d_cluster_name }}"

    - name: Optionally load base image into k3d
      ansible.builtin.command:
        cmd: "k3d image import {{ spark_base_image }} -c {{ k3d_cluster_name }}"
      when: load_images | bool

    - name: Optionally load notebook image into k3d
      ansible.builtin.command:
        cmd: "k3d image import {{ spark_notebook_image }} -c {{ k3d_cluster_name }}"
      when: load_images | bool

    - name: Add Spark Operator Helm repo
      ansible.builtin.command:
        cmd: "helm repo add {{ _helm_spark_operator_repo_name }} {{ _helm_spark_operator_repo_url }}"
      register: spark_repo
      changed_when: "'has been added' in spark_repo.stdout"
      failed_when: spark_repo.rc not in [0]

    - name: Add JupyterHub Helm repo
      ansible.builtin.command:
        cmd: "helm repo add {{ _helm_jupyterhub_repo_name }} {{ _helm_jupyterhub_repo_url }}"
      register: jhub_repo
      changed_when: "'has been added' in jhub_repo.stdout"
      failed_when: jhub_repo.rc not in [0]

    - name: Update Helm repos
      ansible.builtin.command:
        cmd: "helm repo update"
      register: helm_repo_update
      failed_when: false

    - name: Install or upgrade Spark Operator (dev - internet)
      ansible.builtin.command:
        cmd: >
          helm upgrade --install {{ spark_operator_release }} {{ _helm_spark_operator_repo_name }}/spark-operator
          --namespace {{ spark_operator_namespace }} --create-namespace
          -f {{ repo_root }}/k8s/spark-operator/values-base.yaml
          -f {{ repo_root }}/k8s/spark-operator/values-dev.yaml
      when: environment_name | default('internet') == 'internet'

    - name: Install or upgrade Spark Operator (dev - onprem)
      ansible.builtin.command:
        cmd: >
          helm upgrade --install {{ spark_operator_release }} {{ _helm_spark_operator_repo_name }}/spark-operator
          --namespace {{ spark_operator_namespace }} --create-namespace
          -f {{ repo_root }}/k8s/spark-operator/values-base.yaml
          -f {{ repo_root }}/k8s/spark-operator/values-onprem.yaml
          -f {{ repo_root }}/k8s/spark-operator/values-dev.yaml
      when: environment_name | default('internet') == 'onprem'

    - name: Install or upgrade JupyterHub (dev - internet with k3d)
      ansible.builtin.command:
        cmd: >
          helm upgrade --install {{ jupyterhub_release }} {{ _helm_jupyterhub_repo_name }}/jupyterhub
          --namespace {{ jupyterhub_namespace }} --create-namespace
          -f {{ repo_root }}/k8s/jupyterhub/values-base.yaml
          -f {{ repo_root }}/k8s/jupyterhub/values-k3d.yaml
      when: environment_name | default('internet') == 'internet'

    - name: Install or upgrade JupyterHub (dev - onprem with k3d)
      ansible.builtin.command:
        cmd: >
          helm upgrade --install {{ jupyterhub_release }} {{ _helm_jupyterhub_repo_name }}/jupyterhub
          --namespace {{ jupyterhub_namespace }} --create-namespace
          -f {{ repo_root }}/k8s/jupyterhub/values-base.yaml
          -f {{ repo_root }}/k8s/jupyterhub/values-onprem.yaml
          -f {{ repo_root }}/k8s/jupyterhub/values-k3d.yaml
      when: environment_name | default('internet') == 'onprem'

    - name: Create JupyterHub Ingress (routes through Traefik)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/jupyterhub/ingress-k3d.yaml"

    - name: Deploy MinIO (internet)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/minio/minio.yaml"
      when: environment_name | default('internet') == 'internet'

    - name: Deploy MinIO (onprem)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/minio/minio-onprem.yaml"
      when: environment_name | default('internet') == 'onprem'

    - name: Wait for MinIO deployment to be ready
      ansible.builtin.command:
        cmd: "kubectl wait --for=condition=available deployment/minio -n minio --timeout=120s"
      register: minio_wait
      failed_when: false

    - name: Deploy Polaris (internet)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/polaris/polaris.yaml"
      when: environment_name | default('internet') == 'internet'

    - name: Deploy Polaris (onprem)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/polaris/polaris-onprem.yaml"
      when: environment_name | default('internet') == 'onprem'

    - name: Wait for Polaris deployment to be ready
      ansible.builtin.command:
        cmd: "kubectl wait --for=condition=available deployment/polaris -n polaris --timeout=120s"
      register: polaris_wait
      failed_when: false

    - name: Delete existing Polaris bootstrap job (if any)
      ansible.builtin.command:
        cmd: "kubectl delete job polaris-bootstrap-catalog -n polaris --ignore-not-found"

    - name: Bootstrap Polaris S3-backed catalog (internet)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/polaris/polaris-bootstrap.yaml"
      when: environment_name | default('internet') == 'internet'

    - name: Bootstrap Polaris S3-backed catalog (onprem)
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/polaris/polaris-bootstrap-onprem.yaml"
      when: environment_name | default('internet') == 'onprem'

    - name: Create spark-sa ServiceAccount in jhub-dev
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/jupyterhub/service-account.yaml"

    - name: Grant spark-sa access to default namespace
      ansible.builtin.command:
        cmd: "kubectl apply -f {{ repo_root }}/k8s/jupyterhub/spark-rbac.yaml"

    - name: Create spark-sa ServiceAccount in default namespace
      ansible.builtin.command:
        cmd: "kubectl create serviceaccount spark-sa --namespace default"
      register: create_sa_default
      failed_when: create_sa_default.rc not in [0, 1]
      changed_when: create_sa_default.rc == 0

    - name: Display access information
      ansible.builtin.debug:
        msg: |
          ✅ k3d cluster '{{ k3d_cluster_name }}' is ready!
          
          JupyterHub is available at: http://localhost:8080
          Login: any username / password: test
          
          No port-forward needed - k3d's built-in LoadBalancer handles it!
          
          Useful commands:
            kubectl get pods -n jhub-dev
            kubectl get pods -n spark-operator
            k3d cluster list
            k3d cluster stop {{ k3d_cluster_name }}
            k3d cluster delete {{ k3d_cluster_name }}

