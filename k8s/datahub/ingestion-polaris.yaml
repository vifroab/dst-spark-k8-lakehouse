# Kubernetes Job for DataHub Polaris Ingestion
# Runs the datahub CLI to ingest Iceberg metadata from Polaris
# To run: kubectl apply -f ingestion-polaris.yaml
# To re-run: kubectl delete job datahub-ingest-polaris -n datahub && kubectl apply -f ingestion-polaris.yaml
---
apiVersion: batch/v1
kind: Job
metadata:
  name: datahub-ingest-polaris
  namespace: datahub
spec:
  ttlSecondsAfterFinished: 3600  # Clean up after 1 hour
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: datahub-ingestion
          image: acryldata/datahub-ingestion:head
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
            - -c
          args:
            - |
              set -e
              echo "Installing Iceberg connector..."
              pip install --quiet 'acryl-datahub[iceberg]'
              
              echo "Waiting for DataHub GMS to be ready..."
              until curl -sf http://datahub-datahub-gms.datahub.svc:8080/health >/dev/null 2>&1; do
                echo "DataHub GMS not ready yet, sleeping..."
                sleep 5
              done
              
              echo "Waiting for Polaris to be ready..."
              until curl -sf http://polaris.polaris.svc:8182/q/health >/dev/null 2>&1; do
                echo "Polaris not ready yet, sleeping..."
                sleep 5
              done
              
              echo "Starting Polaris ingestion..."
              datahub ingest -c /etc/datahub/polaris-recipe.yaml
              
              echo "Ingestion complete!"
          volumeMounts:
            - name: recipe-config
              mountPath: /etc/datahub
          resources:
            requests:
              cpu: "100m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
      volumes:
        - name: recipe-config
          configMap:
            name: datahub-ingestion-polaris

