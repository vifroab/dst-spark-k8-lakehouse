hub:
  image:
    name: jupyterhub/k8s-hub
    tag: 4.3.1
  config:
    JupyterHub:
      authenticator_class: dummy
    DummyAuthenticator:
      password: "test"
    Authenticator:
      admin_users:
        - user
    KubeSpawner:
      uid: 0
      gid: 0
      fs_gid: 0
      service_account: spark-sa
      automount_service_account_token: true
  extraConfig:
    10-require-minio-password: |
      # Require users to provide MINIO_PASSWORD at spawn time (best practice: per-env MinIO users/policies).
      def options_form(spawner):
          return """
          <label for="minio_password">MinIO password (required)</label>
          <input class="form-control" type="password" name="minio_password" placeholder="Enter MinIO password" required />
          <p class="help-block">
            Your environment (sbx/dev/test/prod) selects the MinIO user and bucket.
            This password must match the selected environment's MinIO user policy.
          </p>
          """

      def options_from_form(formdata):
          pw = ""
          if "minio_password" in formdata and formdata["minio_password"]:
              pw = formdata["minio_password"][0]
          return {"minio_password": pw}

      async def pre_spawn_hook(spawner):
          pw = (spawner.user_options or {}).get("minio_password") or ""
          if not pw:
              raise Exception("MINIO_PASSWORD is required to start your server.")
          spawner.environment["MINIO_PASSWORD"] = pw

      c.KubeSpawner.options_form = options_form
      c.KubeSpawner.options_from_form = options_from_form
      c.KubeSpawner.pre_spawn_hook = pre_spawn_hook

singleuser:
  image:
    name: statkube/spark-notebook
    tag: spark3.5.3-py3.12-1
    pullPolicy: IfNotPresent
  cmd:
    - jupyterhub-singleuser
    - --allow-root
  defaultUrl: "/lab"
  extraEnv:
    SPARK_HOME: "/opt/spark"
    SPARK_MASTER: "k8s://https://kubernetes.default.svc"
    PYSPARK_PYTHON: "python3"
    PYSPARK_DRIVER_PYTHON: "python3"
    # Git configuration - users can set these in their profile or admin can set defaults
    # GIT_USER_NAME: "Your Name"
    # GIT_USER_EMAIL: "your.email@example.com"
  lifecycleHooks:
    postStart:
      exec:
        command:
          - /bin/bash
          - -c
          - |
            # Configure git user from environment variables if set
            if [ -n "$GIT_USER_NAME" ]; then git config --global user.name "$GIT_USER_NAME"; fi
            if [ -n "$GIT_USER_EMAIL" ]; then git config --global user.email "$GIT_USER_EMAIL"; fi